<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - Alpharia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/student-dashboard-clean.css">
    <link rel="stylesheet" href="css/test-taking.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body class="student-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>Alpharia</h2>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="student-dashboard-clean.html" class="nav-link">
                            <i class="fas fa-home"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="take-test.html" class="nav-link active">
                            <i class="fas fa-tasks"></i>
                            <span>My Tests</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="student-progress.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Progress</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-book"></i>
                            <span>Resources</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="student-settings.html" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="user-profile">
                <div class="user-avatar">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=U" alt="User">
                </div>
                <div class="user-info">
                    <h4 id="user-name">Loading...</h4>
                    <small id="user-grade">Grade: --</small>
                </div>
                <a href="#" class="sign-out" id="sign-out-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            
            <script>
            // User Profile Management
            (function() {
                // Wait for Firebase to be fully loaded
                const checkFirebaseProfile = setInterval(() => {
                    if (window.alphariaFirebase) {
                        clearInterval(checkFirebaseProfile);
                        loadUserProfile();
                    }
                }, 100);

                async function loadUserProfile() {
                    try {
                        console.log('Loading user profile...');
                        const { auth, firestore } = window.alphariaFirebase;
                        
                        // Wait for auth state to be ready
                        await new Promise((resolve) => {
                            const unsubscribe = auth.onAuthStateChanged((user) => {
                                unsubscribe();
                                resolve(user);
                            });
                        });

                        const user = auth.currentUser;
                        console.log('Current user:', user);
                        
                        if (!user) {
                            console.log('No user is signed in');
                            return;
                        }

                        // Update the UI with basic user info
                        const nameElement = document.getElementById('user-name');
                        const gradeElement = document.getElementById('user-grade');
                        const avatar = document.getElementById('user-avatar');

                        const displayName = user.displayName || 'Student';
                        nameElement.textContent = displayName;
                        
                        // Set avatar with first letter of the name
                        const firstName = displayName.split(' ')[0];
                        avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(firstName)}&background=random`;
                        avatar.alt = displayName;
                        
                        // Try to get additional user data from Firestore
                        try {
                            await window.firebaseReady;
                            const userDocRef = firestore.doc(`users/${user.uid}`);
                            const userDoc = await firestore.getDoc(userDocRef);
                            
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                console.log('User data from Firestore:', userData);
                                
                                // Update grade if available
                                if (userData.grade) {
                                    gradeElement.textContent = `Grade: ${userData.grade}`;
                                } else {
                                    const grade = userData.gradeLevel || userData.class || userData.level || '--';
                                    gradeElement.textContent = `Grade: ${grade}`;
                                }
                                
                                // Update name from Firestore if available
                                if (userData.name || userData.fullName) {
                                    const name = userData.name || userData.fullName;
                                    nameElement.textContent = name;
                                    const firstName = name.split(' ')[0];
                                    avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(firstName)}&background=random`;
                                    avatar.alt = name;
                                }
                            } else {
                                console.log('No user document found in Firestore');
                            }
                        } catch (firestoreError) {
                            console.error('Error fetching user data from Firestore:', firestoreError);
                        }
                        
                        // Set up sign out functionality
                        const signOutBtn = document.getElementById('sign-out-btn');
                        if (signOutBtn) {
                            signOutBtn.addEventListener('click', async (e) => {
                                e.preventDefault();
                                try {
                                    await auth.signOut();
                                    window.dispatchEvent(new Event('authStateChanged'));
                                } catch (error) {
                                    console.error('Error signing out:', error);
                                }
                            });
                        }
                        
                    } catch (error) {
                        console.error('Error in loadUserProfile:', error);
                        // Fallback to default values
                        document.getElementById('user-name').textContent = 'Student';
                        document.getElementById('user-grade').textContent = 'Grade: --';
                    }
                }
            })();
            </script>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="test-title">Reading Test</h1>
                <div class="test-info">
                    <div class="d-flex align-items-center gap-2">
                        <button id="shuffle-questions-btn" class="btn btn-outline-secondary btn-sm" title="Shuffle questions within sections">
                            <i class="fas fa-random"></i> Shuffle Questions
                        </button>
                        <div class="timer" id="test-timer">30:00</div>
                    </div>
                    <button id="submit-test-btn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Test
                    </button>
                </div>
            </header>

            <!-- Test Metadata -->
            <section class="test-metadata" id="test-metadata" style="display: none;">
                <div class="metadata-container">
                    <div class="metadata-item">
                        <i class="fas fa-user-graduate"></i>
                        <span id="test-grade">Grade: --</span>
                    </div>
                    <div class="metadata-item">
                        <i class="fas fa-clock"></i>
                        <span id="test-time-limit">Time Limit: -- minutes</span>
                    </div>
                    <div class="metadata-item">
                        <i class="fas fa-tasks"></i>
                        <span id="test-sections">Sections: --</span>
                    </div>
                </div>
            </section>
            
            <!-- Test Content -->
            <div id="test-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading test content...</p>
                </div>
            </div>
            
            <!-- Test Navigation -->
            <div class="test-navigation">
                <button id="prev-section-btn" class="btn btn-outline" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <div class="progress-container">
                    <div class="progress-bar" id="test-progress"></div>
                    <div class="progress-text" id="progress-text">1/15</div>
                </div>
                <button id="next-section-btn" class="btn btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <!-- Speech Recognition Modal -->
            <div class="modal" id="speech-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Speak Now</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="prompt-text" id="speech-prompt">
                            <span>Say the word: </span>
                            <strong id="current-prompt-text">Loading...</strong>
                        </div>
                        <div class="recording-indicator" id="recording-indicator" style="display: none;">
                            <div class="pulse"></div>
                            <span>Listening...</span>
                        </div>
                        <div class="recording-visualizer" id="recording-visualizer" style="display: none;">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                        <div class="speech-result" id="speech-result" style="display: none;">
                            <div class="attempts">
                                <span class="attempt-label">Attempts:</span>
                                <div class="attempt-dots" id="attempt-dots">
                                    <span class="dot" data-attempt="1"></span>
                                    <span class="dot" data-attempt="2"></span>
                                    <span class="dot" data-attempt="3"></span>
                                </div>
                            </div>
                            <div class="result-text">
                                <span>You said:</span>
                                <strong id="recognized-text"></strong>
                            </div>
                            <div class="result-feedback" id="result-feedback">
                                <i class="fas" id="result-icon"></i>
                                <span id="result-message"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="try-again-btn" class="btn btn-outline" disabled>
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                        <button id="next-item-btn" class="btn btn-primary" disabled>
                            <i class="fas fa-arrow-right"></i> Next Item
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Test Submission Modal -->
            <div class="modal" id="submit-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Submit Test</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to submit your test? You won't be able to make changes after submission.</p>
                        <div class="submission-summary">
                            <div class="summary-item">
                                <span>Completed:</span>
                                <strong id="completed-count">12/15</strong>
                            </div>
                            <div class="summary-item">
                                <span>Time Spent:</span>
                                <strong id="time-spent">12:45</strong>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="cancel-submit-btn" class="btn btn-outline">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button id="confirm-submit-btn" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Submit Test
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Space for content -->
    <div style="height: 20px;"></div>

    <!-- Firebase SDK and Test Taking Functionality -->
    <script type="module">
        // Import the centralized Firebase configuration and Firestore functions
        import { app, auth, db } from './firebase.js';
        import { 
            onAuthStateChanged, 
            signOut, 
            setPersistence, 
            browserLocalPersistence,
            browserSessionPersistence
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
        import { 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            addDoc, 
            updateDoc, 
            serverTimestamp, 
            onSnapshot 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

        // Set up a global promise that resolves when Firebase is ready
        if (!window.firebaseReady) {
            window.firebaseReady = (async () => {
                try {
                    // Set persistence to LOCAL to maintain session across page refreshes
                    try {
                        await setPersistence(auth, browserLocalPersistence);
                        console.log('Persistence set to LOCAL');
                    } catch (error) {
                        console.error('Error setting persistence:', error);
                        // Fallback to SESSION persistence if LOCAL fails
                        try {
                            await setPersistence(auth, browserSessionPersistence);
                            console.log('Falling back to SESSION persistence');
                        } catch (fallbackError) {
                            console.error('Error setting session persistence:', fallbackError);
                        }
                    }
                    
                    // Make Firebase available globally
                    window.alphariaFirebase = {
                        app,
                        auth,
                        db,
                        firestore: { 
                            collection: (path, ...pathSegments) => collection(db, path, ...pathSegments),
                            doc: (path, ...pathSegments) => doc(db, path, ...pathSegments),
                            getDoc,
                            getDocs,
                            query,
                            where,
                            addDoc,
                            updateDoc,
                            serverTimestamp,
                            onSnapshot
                        },
                        signOut,
                        setPersistence,
                        // Add getUserProfile function
                        getUserProfile: async (userId) => {
                            const userDoc = await getDoc(doc(db, 'users', userId));
                            return userDoc.exists() ? userDoc.data() : null;
                        }
                    };
                    
                    console.log('Firebase initialization complete');
                    return true;
                } catch (error) {
                    console.error('Error initializing Firebase:', error);
                    throw error;
                }
            })();
        }

        // Initialize Firebase services after they're ready
        let firestore, firestoreDoc, firestoreGetDoc;
        
        async function initializeFirestore() {
            try {
                if (window.firebaseReady) {
                    await window.firebaseReady;
                    firestore = window.alphariaFirebase.firestore;
                    firestoreDoc = firestore.doc;
                    firestoreGetDoc = firestore.getDoc;
                    console.log('Firestore services initialized');
                }
            } catch (error) {
                console.error('Error initializing Firestore services:', error);
            }
        }
        
        // Initialize Firestore services
        initializeFirestore();

        // Function to show error message
        function showError(title, message) {
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">${title}</h4>
                        <p>${message}</p>
                    </div>
                `;
                errorContainer.style.display = 'block';
            } else {
                alert(`${title}: ${message}`);
            }
        }

        // Function to get URL parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

    // Function to check if test document exists and is valid
    async function checkTestDocument(testId) {
        try {
            console.log(`[checkTestDocument] Checking test document with ID: ${testId}`);
            
            if (!testId) {
                console.error('No testId provided to checkTestDocument');
                return false;
            }
            
            // Get Firestore instance from window.alphariaFirebase
            const { db, firestore } = window.alphariaFirebase;
            
            // Create a document reference
            const testDocRef = firestore.doc(`tests/${testId}`);
            const testDoc = await firestore.getDoc(testDocRef);
            
            console.log(`[checkTestDocument] Test document exists:`, testDoc.exists());
            
            if (!testDoc.exists()) {
                console.error(`Test with ID ${testId} does not exist`);
                return false;
            }
            
            const testData = testDoc.data();
            console.log('[checkTestDocument] Test data:', testData);
            
            // Check for required top-level fields
            const requiredFields = ['title', 'subject', 'grade', 'sections', 'status', 'teacherId'];
            for (const field of requiredFields) {
                if (!(field in testData)) {
                    console.error(`Test is missing required field: ${field}`);
                    return false;
                }
            }
            
            // Validate sections array
            if (!Array.isArray(testData.sections) || testData.sections.length === 0) {
                console.error('Test must have at least one section');
                return false;
            }
            
            // Validate each section
            for (const section of testData.sections) {
                if (!section.id || !section.title || !section.type || !Array.isArray(section.items)) {
                    console.error('Invalid section structure:', section);
                    return false;
                }
                
                // Validate section items
                if (section.items.length === 0) {
                    console.error(`Section ${section.id} has no items`);
                    return false;
                }
                
                for (const item of section.items) {
                    const requiredItemFields = ['id', 'type', 'content', 'points'];
                    for (const field of requiredItemFields) {
                        if (!(field in item)) {
                            console.error(`Item ${item.id} is missing required field: ${field}`);
                            return false;
                        }
                    }
                }
            }
            
            console.log('[checkTestDocument] Test document is valid');
            return true;
            
        } catch (error) {
            console.error('Error checking test document:', error);
            return false;
        }
    }
    
    // Debug mode flag - set to false in production
    const DEBUG_MODE = true;
    
    // Function to update debug panel
    function updateDebugInfo(message) {
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            const timestamp = new Date().toISOString().substr(11, 12);
            debugContent.innerHTML += `\n[${timestamp}] ${message}`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        console.log(`[DEBUG] ${message}`);
    }

    // Function to ensure user is authenticated
    function ensureAuthenticated() {
        updateDebugInfo('Starting authentication check...');
        
        // Handle no user case
        const handleNoUser = (reject) => {
            updateDebugInfo('No authenticated user found');
            const error = new Error('No user is currently signed in');
            updateDebugInfo('ERROR: ' + error.message);
            
            // Show error on page
            const errorContainer = document.createElement('div');
            errorContainer.style.padding = '20px';
            errorContainer.style.margin = '20px';
            errorContainer.style.border = '2px solid #dc3545';
            errorContainer.style.borderRadius = '5px';
            errorContainer.style.backgroundColor = '#f8d7da';
            errorContainer.style.color = '#721c24';
            errorContainer.innerHTML = `
                <h3>Authentication Required</h3>
                <p>You need to be signed in to access this page.</p>
                <p><button onclick="window.location.href='auth/login-fixed.html?returnUrl=${encodeURIComponent(window.location.href)}'" class="btn btn-primary">Go to Login</button></p>
                <div id="auth-debug-info" style="margin-top: 20px; padding: 10px; background: #f1f1f1; border-radius: 4px; font-family: monospace; white-space: pre; overflow: auto; max-height: 200px;"></div>
            `;
            
            // Clear the page and show the error
            document.body.innerHTML = '';
            document.body.appendChild(errorContainer);
            
            // Copy debug info to the error page
            const debugInfo = document.getElementById('debug-content')?.innerText || 'No debug information available';
            const debugInfoElement = document.getElementById('auth-debug-info');
            if (debugInfoElement) {
                debugInfoElement.textContent = debugInfo;
            }
            
            reject(error);
        };
        
        return new Promise((resolve, reject) => {
            // Main authentication check
            const checkAuth = async () => {
                try {
                    // Wait for Firebase to be fully initialized
                    if (window.firebaseReady) {
                        await window.firebaseReady;
                    } else {
                        throw new Error('Firebase not properly initialized');
                    }
                    
                    const { auth } = window.alphariaFirebase;
                    
                    // Check if we have a valid auth instance
                    if (!auth) {
                        throw new Error('Firebase auth not initialized');
                    }
                    
                    // Debug info
                    updateDebugInfo(`Auth instance: ${auth ? 'Valid' : 'Invalid'}`);
                    updateDebugInfo(`Current user: ${auth?.currentUser?.uid || 'None'}`);
                    
                    // Check for existing user first
                    if (auth.currentUser) {
                        updateDebugInfo(`User already authenticated: ${auth.currentUser.uid}`);
                        
                        // Get user profile
                        try {
                            updateDebugInfo('Fetching user profile...');
                            const userProfile = await window.alphariaFirebase.getUserProfile(auth.currentUser.uid);
                            
                            if (userProfile) {
                                updateDebugInfo('User profile found, authentication successful');
                                window.currentUser = {
                                    ...auth.currentUser,
                                    profile: userProfile
                                };
                                resolve(auth.currentUser);
                                return;
                            } else {
                                throw new Error('User profile not found in database');
                            }
                        } catch (error) {
                            updateDebugInfo(`Error getting user profile: ${error.message}`);
                            handleNoUser(reject);
                            return;
                        }
                    }
                    
                    // Debug info
                    updateDebugInfo(`Auth instance: ${auth ? 'Valid' : 'Invalid'}`);
                    updateDebugInfo(`Current user: ${auth?.currentUser?.uid || 'None'}`);
                    
                    // Check for existing user first
                    if (auth.currentUser) {
                        updateDebugInfo(`User already authenticated: ${auth.currentUser.uid}`);
                        
                        // Get user profile
                        try {
                            updateDebugInfo('Fetching user profile...');
                            const userProfile = await window.alphariaFirebase.getUserProfile(auth.currentUser.uid);
                            
                            if (userProfile) {
                                updateDebugInfo('User profile found, authentication successful');
                                window.currentUser = {
                                    ...auth.currentUser,
                                    profile: userProfile
                                };
                                resolve(auth.currentUser);
                            } else {
                                throw new Error('User profile not found in database');
                            }
                        } catch (error) {
                            updateDebugInfo(`Error getting user profile: ${error.message}`);
                            handleNoUser();
                        }
                        
                        return;
                    }
                    
                    // If no current user, set up auth state listener
                    updateDebugInfo('No current user, setting up auth state listener...');
                    
                    const unsubscribe = auth.onAuthStateChanged(
                        async (user) => {
                            updateDebugInfo(`Auth state changed. User: ${user ? user.uid : 'None'}`);
                            
                            if (!user) {
                                handleNoUser();
                                return;
                            }
                            
                            try {
                                updateDebugInfo('Auth state changed - user found, fetching profile...');
                                const userProfile = await window.alphariaFirebase.getUserProfile(user.uid);
                                
                                if (userProfile) {
                                    updateDebugInfo('User profile found, authentication successful');
                                    window.currentUser = {
                                        ...user,
                                        profile: userProfile
                                    };
                                    resolve(user);
                                } else {
                                    throw new Error('User profile not found in database');
                                }
                            } catch (error) {
                                updateDebugInfo(`Error in auth state change handler: ${error.message}`);
                                handleNoUser();
                            } finally {
                                unsubscribe();
                            }
                        },
                        (error) => {
                            updateDebugInfo('Auth state error: ' + error.message);
                            console.error('Auth state error:', error);
                            reject(error);
                        }
                    );
                    
                    // Set timeout for auth state change
                    const authTimeout = setTimeout(() => {
                        updateDebugInfo('Auth state change timed out');
                        unsubscribe();
                        reject(new Error('Authentication timeout'));
                    }, 30000); // 30 second timeout
                    
                    // Handle test submission
                    async function submitTest() {
                        console.log('Submitting test...');
                        
                        try {
                            // Show loading state
                            const submitBtn = document.getElementById('submit-test-btn');
                            if (submitBtn) {
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                            }
                            
                            // Get the current user
                            const user = auth.currentUser;
                            if (!user) {
                                throw new Error('User not authenticated');
                            }
                            
                            // Prepare test results
                            const testResults = {
                                testId: currentTest.id,
                                testTitle: currentTest.title,
                                studentId: user.uid,
                                studentName: user.displayName || 'Student',
                                submittedAt: new Date().toISOString(),
                                sections: []
                            };
                            
                            // Add section results
                            currentTest.sections.forEach((section, sectionIndex) => {
                                const sectionResult = {
                                    title: section.title,
                                    items: section.items.map((item, itemIndex) => ({
                                        question: item.question,
                                        correctAnswer: item.correctAnswer,
                                        studentAnswer: item.studentAnswer || '',
                                        isCorrect: item.isCorrect || false,
                                        attempts: item.attempts || 0
                                    }))
                                };
                                testResults.sections.push(sectionResult);
                            });
                            
                            // Calculate score
                            const totalItems = testResults.sections.reduce(
                                (total, section) => total + section.items.length, 0
                            );
                            const correctItems = testResults.sections.reduce(
                                (total, section) => total + section.items.filter(item => item.isCorrect).length, 0
                            );
                            
                            testResults.score = Math.round((correctItems / totalItems) * 100);
                            testResults.status = 'completed';
                            
                            console.log('Submitting test results:', testResults);
                            
                            // Save to Firestore
                            const resultRef = await addDoc(collection(db, 'testResults'), testResults);
                            console.log('Test results saved with ID:', resultRef.id);
                            
                            // Show success message
                            alert('Test submitted successfully!');
                            
                            // Redirect to results or dashboard
                            window.location.href = 'student-dashboard.html';
                            
                        } catch (error) {
                            console.error('Error submitting test:', error);
                            alert('Failed to submit test. Please try again.');
                            
                            // Re-enable submit button on error
                            const submitBtn = document.getElementById('submit-test-btn');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = 'Submit Test';
                            }
                        }
                    };
                    
                    // Clean up function
                    return () => {
                        clearTimeout(authTimeout);
                        unsubscribe();
                    };
                    
                } catch (error) {
                    updateDebugInfo('Error in authentication process: ' + error.message);
                    console.error('Authentication error:', error);
                    
                    // Show error on page
                    const errorContainer = document.createElement('div');
                    errorContainer.style.padding = '20px';
                    errorContainer.style.margin = '20px';
                    errorContainer.style.border = '2px solid #dc3545';
                    errorContainer.style.borderRadius = '5px';
                    errorContainer.style.backgroundColor = '#f8d7da';
                    errorContainer.style.color = '#721c24';
                    errorContainer.innerHTML = `
                        <h3>Authentication Error</h3>
                        <p>${error.message || 'An error occurred during authentication'}</p>
                        <button onclick="location.reload()" class="btn btn-warning">Retry</button>
                        <a href="auth/login-fixed.html?returnUrl=${encodeURIComponent(window.location.href)}" class="btn btn-primary">Go to Login</a>
                    `;
                    
                    document.body.innerHTML = '';
                    document.body.appendChild(errorContainer);
                    
                    reject(error);
                }
            };
            
            // Start the authentication check
            checkAuth().catch(error => {
                // In debug mode, we'll show the error on the page
                const errorContainer = document.createElement('div');
                errorContainer.style.padding = '20px';
                errorContainer.style.margin = '20px';
                errorContainer.style.border = '2px solid #dc3545';
                errorContainer.style.borderRadius = '5px';
                errorContainer.style.backgroundColor = '#f8d7da';
                errorContainer.style.color = '#721c24';
                errorContainer.innerHTML = `
                    <h3>Authentication Required</h3>
                    <p>You need to be logged in to access this page.</p>
                    <p><button onclick="window.location.href='auth/login-fixed.html?returnUrl=${encodeURIComponent(window.location.href)}'" 
                       class="btn btn-primary">Go to Login</button></p>
                    <p><button onclick="location.reload()" class="btn btn-secondary">Retry</button></p>
                    <div style="margin-top: 20px; padding: 10px; background: #f1f1f1; border-radius: 4px;">
                        <p><strong>Debug Info:</strong></p>
                        <pre id="auth-debug-info" style="font-size: 12px; max-height: 200px; overflow: auto;"></pre>
                    </div>
                `;
                
                // Clear the page and show the error
                document.body.innerHTML = '';
                document.body.appendChild(errorContainer);
                
                // Copy debug info to the error page
                const debugInfo = document.getElementById('debug-content')?.innerText || 'No debug information available';
                const debugInfoElement = document.getElementById('auth-debug-info');
                if (debugInfoElement) {
                    debugInfoElement.textContent = debugInfo;
                }
                
                console.error('Authentication error:', error);
            });
        });
    }

        // Main initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM fully loaded, initializing test taking...');
            
            try {
                // First ensure user is authenticated
                const user = await ensureAuthenticated();
                console.log('Authenticated user:', user.uid);
                
                // Get test ID from URL
                const testId = getUrlParameter('testId');
                console.log('Test ID from URL:', testId);
                
                if (!testId) {
                    const errorMsg = 'No testId found in URL. Please access this page from the tests list.';
                    console.error(errorMsg);
                    showError('Test Not Found', errorMsg);
                    return;
                }
                    
                // Show loading state
                const testContent = document.getElementById('test-content');
                if (testContent) {
                    testContent.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading test...</span>
                            </div>
                            <p class="mt-3">Loading test, please wait...</p>
                        </div>`;
                }
                
                // Check if the test document exists and is valid
                console.log('Checking test document in Firestore...');
                const isValidTest = await checkTestDocument(testId);
                
                if (isValidTest) {
                    console.log('Test document is valid, loading test...');
                    await loadTest(testId);
                    console.log('Test loaded successfully');
                } else {
                    const errorMsg = 'The test exists but is missing required data or is invalid.';
                    console.error(errorMsg);
                    showError('Invalid Test', 'The test could not be loaded because it is missing required information.');
                }
            } catch (error) {
                console.error('Error during test initialization:', error);
                if (error.message === 'User not authenticated') {
                    // Already handled by ensureAuthenticated
                    return;
                }
                showError('Error', 'An error occurred while initializing the test. Please check the console for details.');
            }
        });
        
        // Test Taking Application - Main Module
        class TestTakingApp {
            constructor() {
                this.currentTest = null;
                this.currentSectionIndex = 0;
                this.currentItemIndex = 0;
                this.userResponses = [];
                this.testTimer = null;
                this.timeLeft = 0;
                this.recognition = null;
                this.isListening = false;
                this.currentAttempts = 0;
                this.MAX_ATTEMPTS = 3;
                
                this.init();
            }
            
            async init() {
                console.log('Initializing Test Taking App...');
                
                // Wait for DOM to be ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.start());
                } else {
                    this.start();
                }
            }
            
            async start() {
                try {
                    // Get test ID from URL
                    const testId = this.getUrlParameter('testId');
                    console.log('Test ID from URL:', testId);
                    
                    if (!testId) {
                        this.showError('Test Not Found', 'No testId found in URL. Please access this page from the tests list.');
                        return;
                    }
                    
                    // Show loading state
                    this.showLoadingState();
                    
                    // Load and start the test
                    await this.loadTest(testId);
                    
                } catch (error) {
                    console.error('Error starting test:', error);
                    this.showError('Error', 'An error occurred while starting the test.');
                }
            }
            
            getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }
            
            showLoadingState() {
                const testContent = document.getElementById('test-content');
                if (testContent) {
                    testContent.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading test...</span>
                            </div>
                            <p class="mt-3">Loading test, please wait...</p>
                        </div>`;
                }
            }
            
            showError(title, message) {
                const testContent = document.getElementById('test-content');
                if (testContent) {
                    testContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>${title}</h4>
                            <p>${message}</p>
                            <a href="student-dashboard.html" class="btn btn-primary mt-2">Back to Dashboard</a>
                        </div>`;
                }
            }
            
            async loadTest(testId) {
                try {
                    console.log(`Loading test with ID: ${testId}`);
                    
                    // Get test data from Firestore
                    const { firestore } = window.alphariaFirebase;
                    const testRef = firestore.doc(`tests/${testId}`);
                    const testDoc = await firestore.getDoc(testRef);
                    
                    if (!testDoc.exists()) {
                        throw new Error(`Test with ID ${testId} not found`);
                    }
                    
                    const testData = testDoc.data();
                    console.log('Test data loaded:', testData);
                    
                    // Process test data
                    this.currentTest = {
                        id: testDoc.id,
                        title: testData.title || 'Untitled Test',
                        description: testData.description || '',
                        grade: testData.grade || 'N/A',
                        subject: testData.subject || 'General',
                        timeLimit: testData.timeLimit || 30,
                        sections: this.processSections(testData.sections || [])
                    };
                    
                    if (this.currentTest.sections.length === 0) {
                        throw new Error('This test has no sections');
                    }
                    
                    // Initialize test UI
                    this.initializeTestUI();
                    
                    // Start the test
                    this.startTest();
                    
                } catch (error) {
                    console.error('Error loading test:', error);
                    this.showError('Error Loading Test', error.message || 'Failed to load test. Please try again later.');
                }
            }
            
            processSections(sections) {
                return sections.map(section => ({
                    id: section.id || `section-${Date.now()}`,
                    title: section.title || 'Test Section',
                    type: section.type || 'letters',
                    instructions: section.instructions || '',
                    items: (section.items || []).map(item => ({
                        id: item.id || `item-${Date.now()}`,
                        type: item.type || 'letter',
                        content: item.content || '',
                        answer: item.answer || '',
                        points: typeof item.points === 'number' ? item.points : 1,
                        attempts: []
                    }))
                }));
            }
            
            initializeTestUI() {
                // Update test metadata
                document.getElementById('test-title').textContent = this.currentTest.title;
                document.getElementById('test-time-limit').textContent = `Time Limit: ${this.currentTest.timeLimit} minutes`;
                document.getElementById('test-sections').textContent = `Sections: ${this.currentTest.sections.length}`;
                document.getElementById('test-grade').textContent = `Grade: ${this.currentTest.grade}`;
                
                // Show test metadata
                document.getElementById('test-metadata').style.display = 'block';
                
                // Initialize timer
                this.timeLeft = this.currentTest.timeLimit * 60;
                this.startTimer();
                
                // Initialize user responses
                this.userResponses = this.initializeUserResponses();
            }
            
            initializeUserResponses() {
                return this.currentTest.sections.map(section => ({
                    sectionId: section.id,
                    sectionTitle: section.title,
                    items: section.items.map(item => ({
                        itemId: item.id,
                        type: item.type,
                        attempts: [],
                        isCorrect: false,
                        score: 0
                    }))
                }));
            }
            
            startTimer() {
                this.testTimer = setInterval(() => {
                    if (this.timeLeft <= 0) {
                        clearInterval(this.testTimer);
                        this.submitTest();
                        return;
                    }
                    
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    document.getElementById('test-timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    this.timeLeft--;
                }, 1000);
            }
            
            startTest() {
                this.currentSectionIndex = 0;
                this.currentItemIndex = 0;
                this.renderCurrentItem();
            }
            
            renderCurrentItem() {
                if (!this.currentTest || !this.currentTest.sections || this.currentTest.sections.length === 0) {
                    console.error('No test data available');
                    return;
                }
                
                const section = this.currentTest.sections[this.currentSectionIndex];
                if (!section || !section.items || section.items.length === 0) {
                    console.error('No items in current section');
                    return;
                }
                
                const item = section.items[this.currentItemIndex];
                if (!item) {
                    console.error('No item found at current index');
                    return;
                }
                
                const totalItems = section.items.length;
                const progress = ((this.currentItemIndex + 1) / totalItems) * 100;
                
                // Update progress
                const progressBar = document.getElementById('test-progress');
                const progressText = document.getElementById('progress-text');
                if (progressBar) progressBar.style.width = `${progress}%`;
                if (progressText) progressText.textContent = `${this.currentItemIndex + 1}/${totalItems}`;
                
                // Render item content
                const testContent = document.getElementById('test-content');
                testContent.innerHTML = `
                    <div class="test-item-container">
                        <div class="item-header">
                            <h3>${section.title || 'Item ' + (this.currentItemIndex + 1)}</h3>
                            <div class="item-progress">${this.currentItemIndex + 1} of ${totalItems}</div>
                        </div>
                        
                        <div class="item-content">
                            <div class="item-prompt">
                                <i class="fas fa-font"></i>
                                <span>Read aloud:</span>
                            </div>
                            <div class="item-text">
                                ${item.content || 'No content available'}
                            </div>
                            
                            <div class="speech-controls">
                                <button id="start-speech-btn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-microphone"></i> Start Speaking
                                </button>
                                <div id="speech-status" class="speech-status"></div>
                            </div>
                            
                            <div class="navigation-buttons">
                                <button id="prev-item-btn" class="btn btn-outline" ${this.currentItemIndex === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button id="next-item-btn" class="btn btn-primary">
                                    ${this.currentItemIndex === totalItems - 1 ? 'Finish' : 'Next'} <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize event listeners
                this.initializeItemEventListeners();
            }
            
            initializeItemEventListeners() {
                // Previous button
                const prevBtn = document.getElementById('prev-item-btn');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (this.currentItemIndex > 0) {
                            this.currentItemIndex--;
                            this.renderCurrentItem();
                        }
                    });
                }
                
                // Next button
                const nextBtn = document.getElementById('next-item-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const section = this.currentTest.sections[this.currentSectionIndex];
                        if (this.currentItemIndex < section.items.length - 1) {
                            this.currentItemIndex++;
                            this.renderCurrentItem();
                        } else {
                            this.submitTest();
                        }
                    });
                }
                
                // Speech button
                const speechBtn = document.getElementById('start-speech-btn');
                if (speechBtn) {
                    speechBtn.addEventListener('click', () => this.startSpeechRecognition());
                }
            }
            
            startSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.updateSpeechStatus('Speech recognition not supported in this browser', 'error');
                    return;
                }
                
                // Stop any ongoing recognition
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                    return;
                }
                
                // Initialize recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';
                
                // Update UI
                const btn = document.getElementById('start-speech-btn');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                    btn.classList.add('btn-danger');
                    btn.classList.remove('btn-primary');
                }
                
                this.updateSpeechStatus('Listening... Speak now', 'listening');
                
                // Event handlers
                this.recognition.onresult = (event) => {
                    const spokenText = event.results[0][0].transcript.trim();
                    this.handleSpeechResult(spokenText);
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.updateSpeechStatus(`Error: ${event.error}`, 'error');
                    this.resetSpeechButton();
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    if (!this.recognition._resultHandled) {
                        this.resetSpeechButton();
                    }
                };
                
                // Start recognition
                this.recognition.start();
                this.isListening = true;
                this.currentAttempts++;
            }
            
            handleSpeechResult(spokenText) {
                this.recognition._resultHandled = true;
                
                const section = this.currentTest.sections[this.currentSectionIndex];
                const item = section.items[this.currentItemIndex];
                const correctAnswer = item.content || '';
                
                // Check if answer is correct
                const isCorrect = this.checkAnswer(spokenText, correctAnswer);
                
                console.log('Speech result:', {
                    spoken: spokenText,
                    correct: correctAnswer,
                    isCorrect: isCorrect
                });
                
                // Update user responses
                const response = this.userResponses[this.currentSectionIndex].items[this.currentItemIndex];
                response.attempts.push({
                    attempt: this.currentAttempts,
                    isCorrect: isCorrect,
                    transcript: spokenText,
                    timestamp: new Date().toISOString()
                });
                
                if (isCorrect) {
                    response.isCorrect = true;
                    response.score = item.points || 1;
                    this.updateSpeechStatus('Correct! Well done.', 'success');
                    
                    const btn = document.getElementById('start-speech-btn');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Correct';
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-success');
                        btn.disabled = true;
                    }
                } else {
                    this.updateSpeechStatus('Try again', 'error');
                    this.resetSpeechButton();
                }
                
                // Reset attempts if correct or max attempts reached
                if (isCorrect || this.currentAttempts >= this.MAX_ATTEMPTS) {
                    this.currentAttempts = 0;
                }
            }
            
            checkAnswer(spoken, correct) {
                const cleanSpoken = spoken.toLowerCase().trim();
                const cleanCorrect = correct.toLowerCase().trim();
                
                if (cleanCorrect.length === 1) {
                    // For single letters, check if spoken starts with the target letter
                    return cleanSpoken === cleanCorrect || cleanSpoken.startsWith(cleanCorrect);
                } else {
                    // For longer answers, use exact match after normalization
                    const normalize = (text) => text.replace(/[^a-z0-9]/g, '');
                    return normalize(cleanSpoken) === normalize(cleanCorrect);
                }
            }
            
            updateSpeechStatus(message, status = '') {
                const statusElement = document.getElementById('speech-status');
                if (!statusElement) return;
                
                statusElement.textContent = message;
                statusElement.className = 'speech-status';
                
                if (status) {
                    statusElement.classList.add(`status-${status}`);
                }
            }
            
            resetSpeechButton() {
                const btn = document.getElementById('start-speech-btn');
                if (btn && !btn.classList.contains('btn-success')) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                }
            }
            
            submitTest() {
                console.log('Submitting test...');
                
                // Calculate results
                let totalQuestions = 0;
                let correctAnswers = 0;
                
                this.currentTest.sections.forEach((section, sectionIndex) => {
                    section.items.forEach((item, itemIndex) => {
                        totalQuestions++;
                        const response = this.userResponses[sectionIndex].items[itemIndex];
                        if (response.isCorrect) {
                            correctAnswers++;
                        }
                    });
                });
                
                const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                
                // Show results
                const testContent = document.getElementById('test-content');
                testContent.innerHTML = `
                    <div class="test-complete text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                        </div>
                        <h3>Test Completed!</h3>
                        <div class="score-display mt-4">
                            <h1 class="display-4">${score}%</h1>
                            <p class="text-muted">You got ${correctAnswers} out of ${totalQuestions} items correct</p>
                        </div>
                        <div class="mt-4">
                            <a href="student-dashboard.html" class="btn btn-primary">
                                <i class="fas fa-tachometer-alt"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                `;
                
                // Clear timer
                if (this.testTimer) {
                    clearInterval(this.testTimer);
                }
            }
        }
        
        // Initialize the test taking application
        new TestTakingApp();
        
        // Load test data from Firestore
        async function loadTest(testId) {
            try {
                console.log(`[loadTest] Starting to load test with ID: ${testId}`);
                
                const testContent = document.getElementById('test-content');
                testContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading test...</p>
                    </div>
                `;
                
                // Get test data from Firestore
                console.log('[loadTest] Accessing Firestore...');
                const { firestore } = window.alphariaFirebase;
                const testRef = firestore.doc(`tests/${testId}`);
                console.log(`[loadTest] Fetching document from path: tests/${testId}`);
                
                const testDoc = await firestore.getDoc(testRef);
                console.log('[loadTest] Firestore response received:', testDoc.exists() ? 'Document exists' : 'Document does not exist');
                
                if (!testDoc.exists()) {
                    throw new Error(`Test with ID ${testId} not found in Firestore`);
                }
                
                const testData = testDoc.data();
                console.log('[loadTest] Test data from Firestore:', testData);
                
                // Transform the test data to match the expected format
                const sections = [];
                if (testData.sections && testData.sections.length > 0) {
                    sections.push({
                        id: testData.sections[0].id || 'section-1',
                        title: testData.sections[0].title || 'Test Section',
                        type: testData.sections[0].type || 'letters',
                        instructions: testData.sections[0].instructions || '',
                        items: (testData.sections[0].items || []).map(item => ({
                            id: item.id || `item-${Date.now()}`,
                            type: item.type || 'letter',
                            content: item.content || '',
                            answer: item.answer || '',
                            points: typeof item.points === 'number' ? item.points : 1,
                            question: item.question || '',
                            example: item.example || '',
                            focusWord: item.focusWord || ''
                        }))
                    });
                }
                
                currentTest = {
                    id: testDoc.id,
                    title: testData.title || 'Untitled Test',
                    description: testData.description || '',
                    grade: testData.grade || 'N/A',
                    subject: testData.subject || 'General',
                    status: testData.status || 'draft',
                    timeLimit: 30, // Default time limit since it's not in the test data
                    sections: sections
                };
                
                console.log(`[loadTest] Processed test data:`, {
                    id: currentTest.id,
                    title: currentTest.title,
                    subject: currentTest.subject,
                    grade: currentTest.grade,
                    sectionCount: currentTest.sections.length,
                    itemCount: currentTest.sections.reduce((count, section) => count + (section.items?.length || 0), 0)
                });
                
                if (currentTest.sections.length === 0) {
                    throw new Error('This test has no sections');
                }

                // Initialize test UI
                document.getElementById('test-title').textContent = currentTest.title;
                document.getElementById('test-time-limit').textContent = `Time Limit: ${currentTest.timeLimit} minutes`;
                document.getElementById('test-sections').textContent = `Sections: ${currentTest.sections.length}`;
                document.getElementById('test-grade').textContent = `Grade: ${currentTest.grade}`;
                
                // Shuffle questions in each section
                currentTest.sections.forEach(section => {
                    if (section.items && section.items.length > 0) {
                        section.items = shuffleArray([...section.items]);
                    }
                });
                
                // Hide the shuffle button since we don't need it anymore
                const shuffleBtn = document.getElementById('shuffle-questions-btn');
                if (shuffleBtn) {
                    shuffleBtn.style.display = 'none';
                }
                
                // No need for shuffle button click handler anymore
                
                // Show test metadata
                document.getElementById('test-metadata').style.display = 'block';
                
                // Initialize test timer
                timeLeft = currentTest.timeLimit * 60; // Convert to seconds
                updateTimer();
                testTimer = setInterval(updateTimer, 1000);
                
                // Initialize user responses
                userResponses = initializeUserResponses(currentTest.sections);
                
                // Start with the first item
                currentSectionIndex = 0;
                currentItemIndex = 0;
                
                // Render the current item
                renderCurrentItem();
                
            } catch (error) {
                console.error('Error loading test:', error);
                const testContent = document.getElementById('test-content');
                testContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error Loading Test</h4>
                        <p>${error.message || 'Failed to load test. Please try again later.'}</p>
                        <a href="student-dashboard.html" class="btn btn-primary mt-2">Back to Dashboard</a>
                    </div>
                `;
            }
        }
        
        let currentTest = null;
        let currentSectionIndex = 0;
        let currentItemIndex = 0;
        let userResponses = [];
        let testTimer = null;
        let timeLeft = 0;
        let isShuffled = false;
        
        // Function to show toast notifications
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || (() => {
                const container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
                return container;
            })();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.padding = '12px 20px';
            toast.style.marginBottom = '10px';
            toast.style.borderRadius = '4px';
            toast.style.color = 'white';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            
            // Set background color based on type
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            toast.style.backgroundColor = colors[type] || colors.info;
            
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Trigger reflow
            toast.offsetHeight;
            
            // Show toast
            toast.style.opacity = '1';
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Helper function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        


        function initializeUserResponses(sections) {
            return sections.map(section => ({
                sectionId: section.id || `section-${Date.now()}`,
                sectionTitle: section.title || 'Section',
                items: (section.items || []).map(item => ({
                    itemId: item.id || `item-${Date.now()}`,
                    type: item.type || 'word',
                    prompt: item.text || '',
                    attempts: [],
                    isCorrect: false
                }))
            }));
        }
        
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(testTimer);
                submitTest();
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('test-timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            timeLeft--;
        }
        
        function renderCurrentItem() {
            console.group('renderCurrentItem');
            console.log('Current section:', currentSectionIndex, 'Item:', currentItemIndex);
            
            if (!currentTest || !currentTest.sections || currentTest.sections.length === 0) {
                console.error('No test data available');
                console.groupEnd();
                return;
            }
            
            const section = currentTest.sections[currentSectionIndex];
            if (!section || !section.items || section.items.length === 0) {
                console.error('No items in current section', {currentSectionIndex, section});
                console.groupEnd();
                return;
            }
            
            const item = section.items[currentItemIndex];
            if (!item) {
                console.error('No item found at index', {currentItemIndex, items: section.items});
                console.groupEnd();
                return;
            }
            
            console.log('Rendering item:', {
                sectionTitle: section.title,
                itemCount: section.items.length,
                currentItem: item,
                testLength: currentTest.sections.length,
                hasAttempts: !!item.attempts,
                attemptCount: item.attempts ? item.attempts.length : 0,
                isLastItem: currentItemIndex >= section.items.length - 1,
                isLastSection: currentSectionIndex >= currentTest.sections.length - 1
            });
            const totalItems = section.items.length;
            
            // Calculate progress
            const progress = ((currentItemIndex + 1) / totalItems) * 100;
            
            // Update progress bar and text
            const progressBar = document.getElementById('test-progress');
            const progressText = document.getElementById('progress-text');
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${currentItemIndex + 1}/${totalItems}`;
            
            // Render the current item
            const testContent = document.getElementById('test-content');
            testContent.innerHTML = `
                <div class="test-item-container">
                    <div class="item-header">
                        <h3>${section.title || 'Item ' + (currentItemIndex + 1)}</h3>
                        <div class="item-progress">${currentItemIndex + 1} of ${totalItems}</div>
                    </div>
                    
                    <div class="item-content">
                        <div class="item-prompt">
                            <i class="fas ${getItemIcon(item.type)}"></i>
                            <span>${getItemPromptText(item.type)}:</span>
                        </div>
                        <div class="item-text">
                            ${item.content || 'No content available'}
                        </div>
                        
                        <div class="speech-controls">
                            <button id="start-speech-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-microphone"></i> Read Aloud
                            </button>
                            <div id="speech-status" class="speech-status"></div>
                        </div>
                        
                        <div class="navigation-buttons">
                            <button id="prev-item-btn" class="btn btn-outline" ${currentItemIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button id="next-item-btn" class="btn btn-primary">
                                ${currentItemIndex === totalItems - 1 ? 'Finish' : 'Next'} <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize event listeners
            initializeItemEventListeners();
            
            // Initialize speech synthesis
            initializeSpeechSynthesis();
            
            // Reinitialize the modal for this question
            initializeModal();
        }
        
        function getItemIcon(itemType) {
            const icons = {
                'letter': 'fa-font',
                'word': 'fa-spell-check',
                'sentence': 'fa-comment-dots',
                'passage': 'fa-paragraph',
                'comprehension': 'fa-book-reader'
            };
            return icons[itemType] || 'fa-tasks';
        }
        
        function getItemPromptText(itemType) {
            const prompts = {
                'letter': 'Letter',
                'word': 'Word',
                'sentence': 'Sentence',
                'passage': 'Passage',
                'comprehension': 'Reading'
            };
            return prompts[itemType] || 'Item';
        }
        
        function renderSectionItems(section, sectionResponses) {
            return (section.items || []).map((item, itemIndex) => {
                const response = sectionResponses.items[itemIndex];
                const statusClass = response.isCorrect ? 'correct' : response.attempts.length > 0 ? 'attempted' : '';
                
                return `
                    <div class="test-item ${statusClass}" data-item-id="${item.id || itemIndex}">
                        <div class="item-prompt">
                            <i class="fas ${getItemIcon(item.type)}"></i>
                            <span>${getItemPromptText(item.type)}:</span>
                        </div>
                        <div class="item-content">
                            <strong>${item.text || 'No content'}</strong>
                        </div>
                        <div class="item-actions">
                            <button class="btn ${response.isCorrect ? 'btn-success' : 'btn-primary'} start-recording" 
                                    data-section-index="${currentSectionIndex}"
                                    data-item-index="${itemIndex}">
                                <i class="fas fa-microphone"></i> 
                                ${response.isCorrect ? 'Completed' : response.attempts.length > 0 ? 'Try Again' : 'Start'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function initializeItemEventListeners() {
            // Previous button
            document.getElementById('prev-item-btn').addEventListener('click', () => {
                if (currentItemIndex > 0) {
                    currentItemIndex--;
                    renderCurrentItem();
                }
            });
            
            // Next button
            document.getElementById('next-item-btn').addEventListener('click', () => {
                const section = currentTest.sections[currentSectionIndex];
                if (currentItemIndex < section.items.length - 1) {
                    currentItemIndex++;
                    renderCurrentItem();
                } else {
                    // Handle test completion
                    submitTest();
                }
            });
            
            // Speech button - now for student to read
            document.getElementById('start-speech-btn').addEventListener('click', startStudentRecording);
            
            // Try again button
            const tryAgainBtn = document.getElementById('try-again-btn');
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', startStudentRecording);
            }
            
            // Next item button in modal
            const nextItemBtn = document.getElementById('next-item-modal-btn');
            if (nextItemBtn) {
                nextItemBtn.addEventListener('click', () => {
                    const section = currentTest.sections[currentSectionIndex];
                    if (currentItemIndex < section.items.length - 1) {
                        currentItemIndex++;
                        renderCurrentItem();
                        closeModal();
                    } else {
                        closeModal();
                        submitTest();
                    }
                });
            }
        }
        
        // Speech recognition and synthesis variables
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let recognition = null;
        let isListening = false;
        let currentAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        function initializeSpeechSynthesis() {
            // Check if speech synthesis is supported
            if (!speechSynthesis) {
                console.warn('Speech synthesis not supported in this browser.');
                const speechBtn = document.getElementById('start-speech-btn');
                if (speechBtn) {
                    speechBtn.disabled = true;
                    speechBtn.title = 'Text-to-speech not supported in your browser';
                }
                return false;
            }
            return true;
        }
        
        function startStudentRecording() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateSpeechStatus('Speech recognition not supported in this browser', 'error');
                return;
            }
            
            // Stop any ongoing recognition
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                return;
            }
            
            // Reset UI
            document.getElementById('start-speech-btn').classList.remove('btn-success', 'btn-danger');
            document.getElementById('start-speech-btn').innerHTML = '<i class="fas fa-microphone"></i> Listening...';
            
            // Show listening indicator
            const statusElement = document.getElementById('speech-status');
            if (statusElement) {
                statusElement.innerHTML = '<div class="listening-indicator"><span></span><span></span><span></span></div>';
            }
            
            // Initialize recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Configure recognition
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            // Start recognition
            recognition.start();
            isListening = true;
            currentAttempts++;
            
            // Update UI
            updateSpeechStatus('Listening... Speak now', 'listening');
            const btn = document.getElementById('start-speech-btn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-primary');
            }
            
            // Event handlers
            recognition.onresult = (event) => {
                const spokenText = event.results[0][0].transcript.trim();
                const section = currentTest.sections[currentSectionIndex];
                const item = section.items[currentItemIndex];
                const correctAnswer = item.content || '';
                
                // For single-letter answers, handle with special care
                let isCorrect;
                const cleanSpoken = spokenText.trim();
                const cleanCorrect = correctAnswer.trim();
                let cleanSpokenLower = '';
                let correctChar = '';
                
                if (cleanCorrect.length === 1) {
                    // For single letters, check if the spoken word starts with the target letter
                    cleanSpokenLower = cleanSpoken.toLowerCase();
                    correctChar = cleanCorrect.toLowerCase();
                    
                    // Handle common speech recognition patterns
                    const commonPatterns = {
                        's': ['es', 'ess', 'ass', 'yes'],
                        'k': ['ok', 'kay', 'okay', 'key'],
                        'f': ['ef', 'eff'],
                        'm': ['em', 'umm'],
                        'n': ['en', 'and'],
                        'l': ['el', 'ell'],
                        'x': ['ex', 'ax']
                    };
                    
                    // Check if the spoken text matches any common pattern for this letter
                    const isCommonPattern = commonPatterns[correctChar]?.some(pattern => 
                        cleanSpokenLower === pattern || 
                        cleanSpokenLower.startsWith(pattern)
                    ) || false;
                    
                    // Check if the spoken text is exactly the letter, starts with it, or matches a common pattern
                    isCorrect = (cleanSpokenLower === correctChar) || 
                               (cleanSpokenLower.startsWith(correctChar) && cleanSpokenLower.length <= 3) ||
                               isCommonPattern;
                               
                    console.log('Single letter comparison:', {
                        spoken: cleanSpoken,
                        correct: cleanCorrect,
                        isCorrect: isCorrect,
                        check: `Starts with ${correctChar}? ${cleanSpokenLower.startsWith(correctChar)}`
                    });
                } else {
                    // For longer answers, use exact match after normalization
                    const normalizeText = (text) => {
                        return text.toLowerCase()
                            .replace(/[^a-z0-9]/g, '') // Remove all non-alphanumeric characters
                            .trim();
                    };
                    isCorrect = normalizeText(cleanSpoken) === normalizeText(cleanCorrect);
                }
                
                console.log('Speech Recognition Debug:', {
                    spokenText: cleanSpoken,
                    correctAnswer: cleanCorrect,
                    isCorrect: isCorrect,
                    ...(cleanCorrect.length === 1 ? {
                        extractedSpoken: cleanSpoken.replace(/[^a-zA-Z]/g, '').toLowerCase(),
                        extractedCorrect: cleanCorrect.toLowerCase()
                    } : {})
                });
                
                // Update UI based on result
                console.log('Updating UI for result:', { isCorrect, spokenText, correctAnswer });
                
                // Get all modal elements using correct selectors
                const modal = document.getElementById('result-modal');
                const modalTitle = modal?.querySelector('#result-title');
                const modalIcon = modal?.querySelector('#result-icon i');
                const modalMessage = modal?.querySelector('#result-message');
                const userAnswerEl = modal?.querySelector('#user-answer');
                const correctAnswerEl = modal?.querySelector('#correct-answer');
                const pointsEarnedEl = modal?.querySelector('#points-earned');
                const tryAgainBtn = modal?.querySelector('#try-again-btn');
                const nextItemBtn = modal?.querySelector('#next-item-modal-btn');
                
                if (modal) {
                    console.log('Modal found, updating content...');
                    
                    // Update modal content based on result
                    if (isCorrect) {
                        console.log('Answer was correct, updating UI...');
                        if (modalTitle) modalTitle.textContent = 'Correct!';
                        if (modalIcon) {
                            modalIcon.className = 'fas fa-check-circle';
                            modalIcon.style.color = '#28a745';
                        }
                        if (modalMessage) modalMessage.textContent = 'Great job! Your answer is correct.';
                        if (pointsEarnedEl) pointsEarnedEl.textContent = '1';
                    } else {
                        console.log('Answer was incorrect, updating UI...');
                        if (modalTitle) modalTitle.textContent = 'Try Again';
                        if (modalIcon) {
                            modalIcon.className = 'fas fa-times-circle';
                            modalIcon.style.color = '#dc3545';
                        }
                        if (modalMessage) modalMessage.textContent = 'That\'s not quite right. Please try again.';
                        if (pointsEarnedEl) pointsEarnedEl.textContent = '0';
                    }
                    
                    // For single-letter answers, always show just the target letter in the UI
                    const displaySpokenText = (cleanCorrect.length === 1) 
                        ? correctChar.toUpperCase() 
                        : spokenText;
                    
                    // Update answer display
                    if (userAnswerEl) userAnswerEl.textContent = displaySpokenText || 'No speech detected';
                    if (correctAnswerEl) correctAnswerEl.textContent = correctAnswer;
                    
                    // Show modal with animation
                    showModal();
                    
                    // Enable/disable navigation buttons based on current position
                    const nextBtn = document.getElementById('next-item-btn');
                    if (nextBtn) {
                        const isLastItem = currentItemIndex >= currentTest.sections[currentSectionIndex].items.length - 1;
                        const isLastSection = currentSectionIndex >= currentTest.sections.length - 1;
                        nextBtn.disabled = isLastItem && isLastSection;
                    }
                }
                
                // Update user responses
                if (!userResponses[currentSectionIndex]) {
                    userResponses[currentSectionIndex] = { items: [] };
                }
                
                if (!userResponses[currentSectionIndex].items[currentItemIndex]) {
                    userResponses[currentSectionIndex].items[currentItemIndex] = {
                        attempts: 0,
                        isCorrect: false,
                        score: 0
                    };
                }
                
                const response = userResponses[currentSectionIndex].items[currentItemIndex];
                response.attempts++;
                
                if (isCorrect) {
                    response.isCorrect = true;
                    response.score = item.points || 1;
                    response.lastAttempt = new Date().toISOString();
                }
                
                // Reset attempts counter if correct or max attempts reached
                if (isCorrect || currentAttempts >= MAX_ATTEMPTS) {
                    currentAttempts = 0;
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                updateSpeechStatus(`Error: ${event.error}`, 'error');
                isListening = false;
                
                const btn = document.getElementById('start-speech-btn');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                
                const btn = document.getElementById('start-speech-btn');
                if (btn && !btn.classList.contains('btn-success')) {
                    btn.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                }
                
                if (currentAttempts > 0 && currentAttempts < MAX_ATTEMPTS) {
                    updateSpeechStatus(`Try again (${currentAttempts}/${MAX_ATTEMPTS} attempts)`, 'warning');
                }
            };
        }
        
        function updateSpeechStatus(message, status = '') {
            const statusElement = document.getElementById('speech-status');
            if (!statusElement) return;
            
            statusElement.textContent = message;
            statusElement.className = 'speech-status';
            
            if (status) {
                statusElement.classList.add(`status-${status}`);
            }
        }
        
        // Function to clean up all modal-related elements
        function cleanupModalElements() {
            console.log('Cleaning up modal elements...');
        }

    // Reset body styles
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
    document.body.classList.remove('modal-open');

    // Remove any inline styles from body that might be causing the overlay
    document.body.style.removeProperty('padding-right');
    document.body.style.removeProperty('background-color');

    // Function to show section complete modal
    function showSectionCompleteModal() {
    console.log('showSectionCompleteModal called');
    const modal = document.getElementById('section-complete-modal');
    if (!modal) {
        console.error('Section complete modal not found');
        return;
    }

    // Clear previous buttons
    const buttonsContainer = document.getElementById('section-complete-buttons');
    buttonsContainer.innerHTML = '';

    const isLastSection = currentSectionIndex >= currentTest.sections.length - 1;

    // Add appropriate buttons
    if (!isLastSection) {
        // Add Next Section button
        const nextSectionBtn = document.createElement('button');
        nextSectionBtn.className = 'btn btn-primary';
        nextSectionBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Next Section';
        nextSectionBtn.onclick = () => {
            closeModal();
            // Move to next section
            currentSectionIndex++;
            currentItemIndex = 0;
            renderCurrentItem();
        };
        buttonsContainer.appendChild(nextSectionBtn);
    } else {
        // Add Submit Test button for the last section
        const submitBtn = document.createElement('button');
        submitBtn.className = 'btn btn-primary';
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Test';
        submitBtn.onclick = () => {
            closeModal();
            showTestSummaryModal();
        };
        buttonsContainer.appendChild(submitBtn);
    }

    // Add View Results button
    const viewResultsBtn = document.createElement('button');
    viewResultsBtn.className = 'btn btn-outline-primary';
    viewResultsBtn.innerHTML = '<i class="fas fa-chart-bar"></i> View Section Results';
    viewResultsBtn.onclick = () => {
        // Show section results
        alert('Section results will be shown here');
        // You can implement a more detailed results view
    };
    buttonsContainer.appendChild(viewResultsBtn);

    // Show the modal
    modal.style.display = 'block';
    document.body.classList.add('modal-open');

    // Add click outside to close
    const closeOnClickOutside = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };

    modal.addEventListener('click', closeOnClickOutside);

    // Store the handler for later removal
    modal._clickHandler = closeOnClickOutside;
}

// Function to show test summary modal
function showTestSummaryModal() {
    console.log('showTestSummaryModal called');
    const modal = document.getElementById('test-summary-modal');
    if (!modal) {
        console.error('Test summary modal not found');
        return;
    }
    
    // Calculate test statistics
    let totalQuestions = 0;
    let correctAnswers = 0;
    const sectionResults = [];
    
    // Process each section
    currentTest.sections.forEach(function(section, index) {
        const sectionQuestions = section.items.length;
        let sectionCorrect = 0;
        
        section.items.forEach(function(item) {
            if (item.attempts && item.attempts.some(function(attempt) { 
                return attempt.isCorrect; 
            })) {
                sectionCorrect++;
                correctAnswers++;
            }
        });
        
        totalQuestions += sectionQuestions;
        const sectionScore = sectionQuestions > 0 ? Math.round((sectionCorrect / sectionQuestions) * 100) : 0;
        
        sectionResults.push({
            title: section.title || 'Section ' + (index + 1),
            correct: sectionCorrect,
            total: sectionQuestions,
            score: sectionScore
        });
    });
    
    const totalScore = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
    
    // Update the UI with calculated values
    document.getElementById('total-questions').textContent = totalQuestions;
    document.getElementById('correct-answers').textContent = correctAnswers;
    document.getElementById('score-percentage').textContent = totalScore + '%';
    
    // Populate section results
    const sectionResultsContainer = document.getElementById('section-results-container');
    if (sectionResultsContainer) {
        sectionResultsContainer.innerHTML = '';
        
        sectionResults.forEach(function(section) {
            const sectionElement = document.createElement('div');
            sectionElement.className = 'section-result-item mb-3';
            sectionElement.innerHTML = [
                '<div>',
                '    <div class="d-flex justify-content-between mb-1">',
                '        <span class="section-title">' + section.title + '</span>',
                '        <span class="section-score">' + section.correct + '/' + section.total + ' (' + section.score + '%)</span>',
                '    </div>',
                '    <div class="progress">',
                '        <div class="progress-bar" role="progressbar" ', 
                '             style="width: ' + section.score + '%" ', 
                '             aria-valuenow="' + section.score + '" ', 
                '             aria-valuemin="0" ', 
                '             aria-valuemax="100">',
                '        </div>',
                '    </div>',
                '</div>'
            ].join('\n');
            
            sectionResultsContainer.appendChild(sectionElement);
        });
    }
    
    // Set up event listeners for modal buttons
    const backToTestBtn = document.getElementById('back-to-test-btn');
    const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
    const closeBtn = modal.querySelector('.close-modal');
    
    // Set up new event listeners with proper scoping
    if (backToTestBtn) {
        backToTestBtn.onclick = function() {
            closeModal();
        };
    }
    
    if (confirmSubmitBtn) {
        confirmSubmitBtn.onclick = function() {
            closeModal().then(function() {
                if (typeof submitTest === 'function') {
                    submitTest();
                }
            });
        };
    }
    
    if (closeBtn) {
        closeBtn.onclick = function() {
            closeModal();
        };
    }
    
    // Show the modal
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
    
    // Add click outside to close
    var closeOnClickOutside = function(e) {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    modal.addEventListener('click', closeOnClickOutside);
    
    // Store the handler for later removal
    modal._clickHandler = closeOnClickOutside;
}

// Function to close any modal
function closeModal() {
    console.log('closeModal called');
    const modals = document.querySelectorAll('.modal');

    return new Promise((resolve) => {
        modals.forEach(modal => {
            if (modal.style.display !== 'none') {
                modal.style.opacity = '0';

                // Remove click handler if it exists
                if (modal._clickHandler) {
                    modal.removeEventListener('click', modal._clickHandler);
                    delete modal._clickHandler;
                }

                // Wait for transition to complete before hiding
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    resolve();
                }, 300);
            }
        });

        if (modals.length === 0) {
            resolve();
        }
    });
}

// Show modal function
function showModal() {
    console.log('showModal called');
    const modal = document.getElementById('result-modal');

    if (!modal) {
        console.error('Modal element not found!');
        return;
    }

    // Cancel any pending close operations
    if (window.modalCloseTimeout) {
        clearTimeout(window.modalCloseTimeout);
        window.modalCloseTimeout = null;
    }

    console.log('Showing modal...');

    // Add visible class and remove any inline styles that might interfere
    modal.className = 'visible';
    modal.style.cssText = '';

    // Get or create modal content
    let modalContent = modal.querySelector('.modal-content');
    if (!modalContent) {
        modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.innerHTML = `
            <div class="modal-header">
                <h3>Result</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button id="try-again-btn" class="btn btn-secondary">Try Again</button>
                <button id="next-item-btn" class="btn btn-primary">Next Item</button>
            </div>
        `;
        modal.appendChild(modalContent);

        // Add event listeners
        const closeBtn = modalContent.querySelector('.close-modal');
        const tryAgainBtn = modalContent.querySelector('#try-again-btn');
        const nextItemBtn = modalContent.querySelector('#next-item-btn');

        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }

        if (tryAgainBtn) {
            tryAgainBtn.addEventListener('click', () => {
                closeModal();
                // Re-enable the speech button
                const speechBtn = document.getElementById('start-speech-btn');
                if (speechBtn) {
                    speechBtn.disabled = false;
                    speechBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Speaking';
                    speechBtn.classList.remove('btn-success', 'btn-danger');
                    speechBtn.classList.add('btn-primary');
                }
            });
        }

        if (nextItemBtn) {
            nextItemBtn.addEventListener('click', () => {
                closeModal();
                // Move to next item
                currentItemIndex++;
                if (currentItemIndex >= currentTest.sections[currentSectionIndex].items.length) {
                    currentSectionIndex++;
                    currentItemIndex = 0;
                    if (currentSectionIndex >= currentTest.sections.length) {
                        // Test is complete
                        alert('Test completed!');
                        return;
                    }
                }
                renderCurrentItem();
            });
        }

        // Initialize speech synthesis when voices are loaded
        if (speechSynthesis) {
            speechSynthesis.onvoiceschanged = initializeSpeechSynthesis;
        }
        
        // Set up modal button event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Close modal when clicking the close button
            const closeBtn = document.querySelector('.close-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // Try Again button
            const tryAgainBtn = document.getElementById('try-again-btn');
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', () => {
                    closeModal();
                    // Re-enable the speech button
                    const speechBtn = document.getElementById('start-speech-btn');
                    if (speechBtn) {
                        speechBtn.disabled = false;
                        speechBtn.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                        speechBtn.classList.remove('btn-success', 'btn-danger');
                        speechBtn.classList.add('btn-primary');
                    }
                });
            }
            
            // Next Item button
            const nextItemBtn = document.getElementById('next-item-modal-btn');
            if (nextItemBtn) {
                nextItemBtn.addEventListener('click', () => {
                    closeModal();
                    // Move to next question or section
                    if (currentItemIndex < currentTest.sections[currentSectionIndex].items.length - 1) {
                        currentItemIndex++;
                    } else if (currentSectionIndex < currentTest.sections.length - 1) {
                        currentSectionIndex++;
                        currentItemIndex = 0;
                    }
                    renderCurrentItem();
                });
            }
        });
        
        // Function to initialize the modal
        function initializeModal() {
            console.log('Initializing modal...');
            const modal = document.getElementById('result-modal');
            if (!modal) {
                console.error('Modal element not found during initialization');
                return;
            }
            
            // Reset modal styles
            modal.style.display = 'none';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            
            // Reset modal content styles
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.transform = 'translateY(0)';
                modalContent.style.opacity = '1';
                modalContent.style.pointerEvents = 'auto';
            }
            
            // Set up close button
            const closeBtn = modal.querySelector('.close-modal');
            if (closeBtn) {
                // Remove any existing click handlers first
                const newCloseBtn = closeBtn.cloneNode(true);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
                
                newCloseBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                };
            }
            
            // Set up next item button
            const nextBtn = document.getElementById('next-item-modal-btn');
            if (nextBtn) {
                // Remove any existing click handlers first
                const newNextBtn = nextBtn.cloneNode(true);
                nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
                
                newNextBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    console.log('Next item button clicked');
                    
                    // Handle next button click
                    function handleNextButtonClick() {
                        console.group('handleNextButtonClick');
                        console.log('Current state:', {
                            currentSectionIndex,
                            currentItemIndex,
                            sectionCount: currentTest.sections.length,
                            itemsInCurrentSection: currentTest.sections[currentSectionIndex]?.items?.length || 0
                        });
                        
                        const currentSection = currentTest.sections[currentSectionIndex];
                        if (!currentSection) {
                            console.error('Current section not found!', {currentSectionIndex});
                            console.groupEnd();
                            return;
                        }
                        
                        const isLastItem = currentItemIndex >= currentSection.items.length - 1;
                        const isLastSection = currentSectionIndex >= currentTest.sections.length - 1;
                        
                        console.log('Navigation state:', {
                            isLastItem,
                            isLastSection,
                            currentItemIndex,
                            itemsInSection: currentSection.items.length
                        });
                        
                        // Close the modal first and handle navigation
                        const handleNavigation = () => {
                            if (isLastItem && isLastSection) {
                                console.log('Last question of last section - submitting test');
                                console.groupEnd();
                                submitTest();
                            } else if (isLastItem) {
                                // Show section complete modal for non-last sections
                                console.log('Last item of section - showing section complete modal');
                                console.groupEnd();
                                showSectionCompleteModal();
                            } else {
                                // Move to next question in current section
                                currentItemIndex++;
                                attempts = 0;
                                console.log(`Moving to next item: ${currentItemIndex} in current section`);
                                console.groupEnd();
                                renderCurrentItem();
                            }
                        };
                        
                        // Close modal if it's open, then handle navigation
                        const modal = document.getElementById('result-modal');
                        if (modal && modal.style.display !== 'none') {
                            closeModal().then(handleNavigation).catch(error => {
                                console.error('Error closing modal:', error);
                                handleNavigation(); // Continue with navigation even if close fails
                            });
                        } else {
                            handleNavigation();
                        }
                    }
                    
                    handleNextButtonClick();
                };
            }
        }
        
        // Initialize speech synthesis when voices are loaded
        if (speechSynthesis) {
            speechSynthesis.onvoiceschanged = initializeSpeechSynthesis;
        }
        
        // Set up modal button event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Close modal when clicking the close button
            const closeBtn = document.querySelector('.close-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // Try Again button
            const tryAgainBtn = document.getElementById('try-again-btn');
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', () => {
                    closeModal();
                    // Re-enable the speech button
                    const speechBtn = document.getElementById('start-speech-btn');
                    if (speechBtn) {
                        speechBtn.disabled = false;
                        speechBtn.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                        speechBtn.classList.remove('btn-success', 'btn-danger');
                        speechBtn.classList.add('btn-primary');
                    }
                });
            }
            
            // Next Item button
            const nextItemBtn = document.getElementById('next-item-modal-btn');
            if (nextItemBtn) {
                nextItemBtn.addEventListener('click', () => {
                    closeModal();
                    // Move to next question or section
                    if (currentItemIndex < currentTest.sections[currentSectionIndex].items.length - 1) {
                        currentItemIndex++;
                    } else if (currentSectionIndex < currentTest.sections.length - 1) {
                        currentSectionIndex++;
                        currentItemIndex = 0;
                    }
                    renderCurrentItem();
                });
            }
        });
        
        // Remove duplicate initializeModal function to avoid redeclaration errors
        
        // Close any open blocks or functions that might be causing the 'Unexpected end of input' error
        if (typeof initializeModal === 'undefined') {
            window.initializeModal = function() {
                // Implementation if needed
                console.log('Modal initialization function called');
            };
        }
        
        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            if (typeof initializeModal === 'function') {
                try {
                    initializeModal();
                } catch (error) {
                    console.error('Error initializing modal:', error);
                }
            }
        });
    </script>
    <!-- Result Modal -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Result</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be dynamically inserted here -->
            </div>
            <div class="modal-footer">
                <button id="next-item-modal-btn" class="btn btn-primary">Next Item</button>
                <button id="try-again-btn" class="btn btn-outline" style="margin-right: 10px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Section Complete Modal -->
    <div id="section-complete-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Section Complete!</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4" style="font-size: 4rem; color: #28a745;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 id="section-complete-message">You've completed the section!</h4>
                <p id="section-complete-details" class="text-muted">Great work! You've answered all questions in this section.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button id="continue-to-next-section" class="btn btn-primary">
                    Continue to Next Section
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Section Complete Modal Styles */
        #section-complete-modal .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 30px;
            text-align: center;
        }
        
        #section-complete-modal .fa-check-circle {
            color: #28a745;
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        #section-complete-modal h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        #section-complete-modal p {
            color: #6c757d;
            margin-bottom: 25px;
        }
        
        #section-complete-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        #section-complete-buttons .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        #section-complete-buttons .btn-primary {
            background-color: #4a6fa5;
            border-color: #4a6fa5;
        }
        
        #section-complete-buttons .btn-outline-primary {
            color: #4a6fa5;
            border-color: #4a6fa5;
        }
        
        #section-complete-buttons .btn-outline-primary:hover {
            background-color: #4a6fa5;
            color: white;
        }
        
        /* Test Summary Modal Styles */
        #test-summary-modal .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 90%;
            margin: 30px auto;
        }
        
        #test-summary-modal .modal-header {
            border-bottom: 1px solid #eee;
            padding: 20px 30px;
            text-align: center;
        }
        
        #test-summary-modal .modal-body {
            padding: 25px 30px;
        }
        
        #test-summary-modal .summary-stats {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        #test-summary-modal .summary-stats h4 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        #test-summary-modal .summary-stats p {
            color: #6c757d;
            margin-bottom: 0;
            font-size: 14px;
        }
        
        #test-summary-modal .section-results {
            margin-bottom: 25px;
        }
        
        #test-summary-modal .section-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        #test-summary-modal .section-result-item:last-child {
            border-bottom: none;
        }
        
        #test-summary-modal .section-title {
            font-weight: 500;
            color: #2c3e50;
        }
        
        #test-summary-modal .section-score {
            font-weight: 600;
            color: #4a6fa5;
        }
        
        #test-summary-modal .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            margin-top: 8px;
        }
        
        #test-summary-modal .progress-bar {
            background-color: #4a6fa5;
            border-radius: 4px;
        }
        
        #test-summary-modal .modal-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px 30px;
            border-top: 1px solid #eee;
        }
        
        #test-summary-modal .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        #test-summary-modal .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }
        
        #test-summary-modal .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }
        
        #test-summary-modal .btn-primary {
            background-color: #4a6fa5;
            border-color: #4a6fa5;
        }
        
        #test-summary-modal .btn-primary:hover {
            background-color: #3a5a80;
            border-color: #3a5a80;
        }
        
        /* Modal Styles */
        #result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #result-modal.visible {
            display: flex;
            opacity: 1;
        }
        
        .modal-visible {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #result-modal.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .recognized-text {
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-family: monospace;
            display: inline-block;
            margin: 5px 0;
        }
        
        .expected-answer {
            color: #28a745;
            font-weight: bold;
            background-color: #f0fff4;
            padding: 2px 6px;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        /* Test Item Styles */
        .test-item-container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 800px;
            margin: 2rem auto;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .item-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .item-progress {
            background: #f0f4f8;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            color: #4a6fa5;
        }
        
        .item-content {
            text-align: center;
            padding: 1rem 0;
        }
        
        .item-prompt {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: #666;
            font-size: 1.1rem;
        }
        
        .item-prompt i {
            color: #4a6fa5;
        }
        
        .item-text {
            font-size: 2rem;
            font-weight: bold;
            margin: 2rem 0;
            line-height: 1.4;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid #4a6fa5;
        }
        
        .speech-controls {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        #start-speech-btn {
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            border-radius: 30px;
            transition: all 0.3s ease;
        }
        
        #start-speech-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        #start-speech-btn.btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .speech-status {
            font-size: 0.9rem;
            color: #666;
            min-height: 1.5rem;
            margin-top: 0.5rem;
        }
        
        .speech-status.status-reading {
            color: #4a6fa5;
            font-weight: 500;
        }
        
        .speech-status.status-complete {
            color: #28a745;
        }
        
        .speech-status.status-error {
            color: #dc3545;
        }
        
        .speech-status.status-stopped {
            color: #6c757d;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .navigation-buttons .btn {
            min-width: 120px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .test-item-container {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .item-text {
                font-size: 1.5rem;
                padding: 1.5rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            
            .navigation-buttons .btn {
                width: 100%;
            }
        }
    .test-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        text-align: center;
    }
    .word-display {
        font-size: 3rem;
        font-weight: bold;
        color: #4a6cf7;
        margin: 2rem 0;
        text-align: center;
        min-height: 4.5rem;
    }
    .result-container {
        margin: 2rem 0;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(10px);
        height: 0;
        overflow: hidden;
    }
    .result-container.show {
        opacity: 1;
        transform: translateY(0);
        height: auto;
        padding: 1.5rem;
        margin: 2rem 0;
    }
    .correct {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .incorrect {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .correction {
        font-size: 1.5rem;
        margin: 1rem 0;
        font-weight: bold;
    }
    .microphone-btn {
        padding: 1rem 2rem;
        font-size: 1.25rem;
        border-radius: 50px;
        transition: all 0.3s ease;
    }
    .microphone-btn.listening {
        background-color: #dc3545;
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
    }
    .attempts {
        margin-top: 1.5rem;
        color: #6c757d;
    }
    .attempts span {
        font-weight: bold;
        color: #4a6cf7;
    }
    .speech-status {
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 4px;
        text-align: center;
        min-height: 24px;
    }
    .listening-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 4px;
        height: 24px;
    }
    .listening-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #007bff;
        border-radius: 50%;
        animation: bounce 1.5s infinite ease-in-out;
    }
    .listening-indicator span:nth-child(1) { animation-delay: 0s; }
    .listening-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .listening-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const testContent = document.getElementById('test-content');
        
        // Get test ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('id');
        
        if (!testId) {
            testContent.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error: No Test Specified</h4>
                    <p>No test ID provided. Please access this page from the tests list.</p>
                    <a href="student-dashboard.html" class="btn btn-primary">Back to Dashboard</a>
                </div>
            `;
            return;
        let currentTest = null;
        let currentSectionIndex = 0;
        let currentItemIndex = 0;
        // Initialize the test taking application
        new TestTakingApp();
        
        // Render the current test item
        function renderCurrentItem() {
            if (!currentTest) return;
            
            const section = currentTest.sections[currentSectionIndex];
            const item = section.items[currentItemIndex];
            const isLastSection = currentSectionIndex === currentTest.sections.length - 1;
            const isLastItem = currentItemIndex === section.items.length - 1;
            
            // Calculate progress
            const totalItems = currentTest.sections.reduce((sum, sec) => sum + sec.items.length, 0);
            let completedItems = 0;
            
            // Count completed items
            for (let i = 0; i < currentTest.sections.length; i++) {
                const sec = currentTest.sections[i];
                for (let j = 0; j < sec.items.length; j++) {
                    if (i < currentSectionIndex || (i === currentSectionIndex && j < currentItemIndex)) {
                        completedItems++;
                    }
                }
            }
            
            const progress = Math.round((completedItems / totalItems) * 100);
            
            testContent.innerHTML = `
                <div class="test-container">
                    <div class="card">
                        <div class="card-header">
                            <h3>${currentTest.title || 'Speaking Test'}</h3>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: ${progress}%" 
                                    aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">${completedItems} of ${totalItems} items completed</small>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h4>${section.title || 'Section ' + (currentSectionIndex + 1)}</h4>
                                <p class="text-muted">${section.instructions || 'Please speak the following:'}</p>
                            </div>
                            
                            <div class="word-display">
                                ${item.text || item.content || 'No content'}
                            </div>
                            
                            <div class="text-center mt-4">
                                <button id="startTestBtn" class="btn btn-primary microphone-btn" style="min-width: 200px;">
                                    <i class="fas fa-microphone"></i> Click to Speak
                                </button>
                                
                                <div class="attempts mt-3">Attempts: <span>0</span></div>
                                
                                <div id="resultContainer" class="result-container">
                                    <div id="resultIcon" style="font-size: 2.5rem; margin-bottom: 1rem;"></div>
                                    <div id="resultText" class="correction"></div>
                                    <p id="resultMessage"></p>
                                </div>
                                
                                <div class="mt-4">
                                    ${currentSectionIndex > 0 || currentItemIndex > 0 ? `
                                        <button id="prevBtn" class="btn btn-outline" style="margin-right: 1rem;">
                                            <i class="fas fa-arrow-left"></i> Previous
                                        </button>
                                    ` : ''}
                                    
                                    ${!isLastSection || !isLastItem ? `
                                        <button id="nextBtn" class="btn btn-primary">
                                            Next <i class="fas fa-arrow-right"></i>
                                        </button>
                                    ` : `
                                        <button id="submitBtn" class="btn btn-success">
                                            <i class="fas fa-check"></i> Submit Test
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            if (nextBtn) {
                console.group('Next Button Setup');
                console.log('Setting up next button with current state:', {
                    currentSectionIndex,
                    currentItemIndex,
                    sectionCount: currentTest.sections.length,
                    itemsInCurrentSection: currentTest.sections[currentSectionIndex]?.items?.length || 0
                });
                
                // Remove any existing event listeners to prevent duplicates
                const newNextBtn = nextBtn.cloneNode(true);
                nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
                
                newNextBtn.addEventListener('click', () => {
                    console.group('Next Button Clicked');
                    console.log('Button state at click:', {
                        currentSectionIndex: currentSectionIndex,
                        currentItemIndex: currentItemIndex
                    });
                    
                    if (currentItemIndex >= currentTest.sections[currentSectionIndex].items.length - 1) {
                        // If this is the last item in the section, show section complete modal
                        showSectionCompleteModal();
                        console.groupEnd();
                        return;
                    } else {
                        // Move to next question in current section
                        currentItemIndex++;
                        attempts = 0;
                        console.log(`Moving to next item: ${currentItemIndex} in current section`);
                        renderCurrentItem();
                        console.groupEnd(); // Close click group
                        renderCurrentItem();
                        return;
                    }
                });
                
                console.log('Next button setup complete');
                console.groupEnd(); // Close setup group
                
                // Update the reference to the new button
                nextBtn = newNextBtn;
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    // Move to previous item or section
                    if (currentItemIndex > 0) {
                        currentItemIndex--;
                    } else if (currentSectionIndex > 0) {
                        currentSectionIndex--;
                        currentItemIndex = currentTest.sections[currentSectionIndex].items.length - 1;
                    }
                    attempts = 0;
                    renderCurrentItem();
                });
            }
            
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to submit your test? You cannot change your answers after submitting.')) {
                        submitTest();
                    }
                });
            }
            
            // Initialize speech recognition
            initializeSpeechButton();
        }
        
        // Initialize speech recognition button
        function initializeSpeechButton() {
            const startButton = document.getElementById('startTestBtn');
            if (!startButton) return;
            
            // Remove any existing event listeners
            const newButton = startButton.cloneNode(true);
            startButton.parentNode.replaceChild(newButton, startButton);
            
            // Add new event listener
            newButton.addEventListener('click', function() {
                if (isListening) {
                    recognition.stop();
                    return;
                }
                
                // Reset UI
                const resultContainer = document.getElementById('resultContainer');
                if (resultContainer) {
                    resultContainer.className = 'result-container';
                }
                
                newButton.classList.add('listening');
                newButton.innerHTML = '<i class="fas fa-microphone-slash"></i> Listening...';
                
                // Start recognition
                recognition.start();
                isListening = true;
            });
        }
        
        // Submit the test
        async function submitTest() {
            console.group('submitTest');
            console.log('Starting test submission with state:', {
                currentSectionIndex,
                currentItemIndex,
                sectionCount: currentTest.sections.length,
                itemsInCurrentSection: currentTest.sections[currentSectionIndex]?.items?.length || 0,
                testSubmitted: window.testSubmitted
            });
            
            // Prevent multiple submissions
            if (window.testSubmitted) {
                console.warn('Test already submitted, ignoring duplicate submission');
                console.groupEnd();
                return;
            }
            window.testSubmitted = true;
            
            const testContent = document.getElementById('test-content');
            if (!testContent) return;
            
            try {
                // Disable all buttons to prevent further interactions
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.disabled = true;
                });
                
                // Show loading state
                testContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Submitting test...</span>
                        </div>
                        <p class="mt-3">Submitting your test...</p>
                    </div>
                `;
                
                // Calculate score
                let totalItems = 0;
                let correctItems = 0;
                
                currentTest.sections.forEach(section => {
                    section.items.forEach(item => {
                        totalItems++;
                        if (item.attempts && item.attempts.some(attempt => attempt.isCorrect)) {
                            correctItems++;
                        }
                    });
                });
                
                const score = Math.round((correctItems / totalItems) * 100);
                
                // In a real app, you would save this to Firestore:
                try {
                    const db = firebase.firestore();
                    const testAttempt = {
                        testId: currentTest.id,
                        testTitle: currentTest.title,
                        studentId: firebase.auth().currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        score: score,
                        totalItems: totalItems,
                        correctItems: correctItems,
                        completed: true,
                        // Save a summary instead of the entire test to reduce document size
                        sections: currentTest.sections.map(section => ({
                            id: section.id,
                            title: section.title,
                            itemCount: section.items.length,
                            correctCount: section.items.filter(item => 
                                item.attempts && item.attempts.some(a => a.isCorrect)
                            ).length
                        }))
                    };
                    
                    await db.collection('testAttempts').add(testAttempt);
                    console.log('Test attempt saved successfully');
                } catch (dbError) {
                    console.error('Error saving to Firestore:', dbError);
                    // Continue even if save fails, but log it
                }
                
                // Show success message
                const successHtml = `
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                        </div>
                        <h3>Test Submitted Successfully!</h3>
                        <div class="score-display mt-4">
                            <h1 class="display-4">${score}%</h1>
                            <p class="text-muted">You got ${correctItems} out of ${totalItems} items correct</p>
                        </div>
                        <div class="mt-4">
                            <a href="student-dashboard.html" class="btn btn-primary">
                                <i class="fas fa-tachometer-alt"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                `;
                
                // Use setTimeout to ensure smooth transition
                setTimeout(() => {
                    testContent.innerHTML = successHtml;
                    
                    // Re-enable the dashboard button
                    const dashboardBtn = testContent.querySelector('.btn-primary');
                    if (dashboardBtn) {
                        dashboardBtn.disabled = false;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting test:', error);
                testContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error Submitting Test</h4>
                        <p>There was an error submitting your test. Please try again later.</p>
                        <div class="mt-3">
                            <button onclick="window.location.reload()" class="btn btn-warning">
                                <i class="fas fa-sync"></i> Try Again
                            </button>
                            <a href="student-dashboard.html" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                `;
            }
        }
        
        // Function to show section complete modal
        function showSectionCompleteModal() {
            console.group('showSectionCompleteModal');
            const modal = document.getElementById('section-complete-modal');
            const closeBtn = modal.querySelector('.close-modal');
            const continueBtn = document.getElementById('continue-to-next-section');
            
            // Set up close button
            closeBtn.onclick = () => {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            };
            
            // Set up continue button
            continueBtn.onclick = () => {
                console.log('Continue to next section clicked');
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
                // Move to next section
                if (currentSectionIndex < currentTest.sections.length - 1) {
                    currentSectionIndex++;
                    currentItemIndex = 0;
                    attempts = 0;
                    console.log(`Moving to section ${currentSectionIndex}, item 0`);
                    renderCurrentItem();
                } else {
                    console.log('No more sections - submitting test');
                    submitTest();
                }
            };
            
            // Show the modal
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            console.groupEnd();
        }
        
        // Initialize speech recognition if available
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            // Disable any built-in corrections or processing
            if ('webkitSpeechGrammarList' in window) {
                // Create a grammar that accepts anything (effectively disabling the default grammar)
                const grammar = '#JSGF V1.0; grammar anything; public <anything> = * ;';
                const speechRecognitionList = new webkitSpeechGrammarList();
                speechRecognitionList.addFromString(grammar, 1);
                recognition.grammars = speechRecognitionList;
            }
            
            // Handle button click
            const startButton = document.getElementById('startTestBtn');
            if (startButton) {
                startButton.addEventListener('click', function() {
                    const resultContainer = document.getElementById('resultContainer');
                    
                    if (isListening) {
                        recognition.stop();
                        return;
                    }
                    
                    // Reset UI
                    if (resultContainer) {
                        resultContainer.className = 'result-container';
                    }
                    
                    startButton.classList.add('listening');
                    startButton.innerHTML = '<i class="fas fa-microphone-slash"></i> Listening...';
                    
                    // Start recognition
                    recognition.start();
                    isListening = true;
                });
            }
        
        // Helper function to normalize text for comparison - case insensitive
        function normalizeText(text) {
            if (!text) return '';
            
            // Convert to lowercase for case-insensitive comparison
            // but still preserve the original for display
            return text.trim().toLowerCase();
        }
        
        // Handle recognition result
        recognition.onresult = function(event) {
            if (!currentTest) return;
            
            const section = currentTest.sections[currentSectionIndex];
            const item = section.items[currentItemIndex];
            
            const speechResult = event.results[0][0].transcript.trim();
            const target = (item.text || item.content || '').trim();
            
            // For debugging
            console.log('Raw speech result:', speechResult);
            console.log('Raw target:', target);
            
            // For single-letter answers, do an exact match (case-insensitive)
            let isCorrect;
            if (target.length === 1) {
                console.log('Single letter answer detected');
                console.log('Speech result:', JSON.stringify(speechResult));
                console.log('Target:', JSON.stringify(target));
                
                // Get the first character of the speech result and target, removing any non-letter characters
                const speechChar = speechResult.replace(/[^a-zA-Z]/g, '').charAt(0).toLowerCase();
                const targetChar = target.replace(/[^a-zA-Z]/g, '').charAt(0).toLowerCase();
                
                console.log('Speech char:', speechChar);
                console.log('Target char:', targetChar);
                
                // Only mark as correct if the speech result is exactly one letter and matches the target
                isCorrect = speechResult.length > 0 && 
                          speechChar === targetChar &&
                          speechResult.replace(/[^a-zA-Z]/g, '').length === 1;
            } else {
                // For longer answers, do a normalized comparison
                isCorrect = normalizeText(speechResult) === normalizeText(target);
            }
            
            console.log('isCorrect:', isCorrect);
            
            // For debugging
            console.log('Heard:', speechResult);
            console.log('Expected:', target);
            console.log('Match:', isCorrect);
            
            // Update attempts
            attempts++;
            const attemptsSpan = document.querySelector('.attempts span');
            if (attemptsSpan) {
                attemptsSpan.textContent = attempts;
            }
            
            // Show result in the modal
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const message = document.getElementById('result-message');
            const icon = document.getElementById('result-icon');
            const userAnswerEl = document.getElementById('user-answer');
            const correctAnswerEl = document.getElementById('correct-answer');
            const pointsEl = document.getElementById('points-earned');
            const nextButton = document.getElementById('next-item-modal-btn');
            
            if (!modal) {
                console.error('Result modal elements not found');
                return;
            }
            
            // Show the recognized text in the console for debugging
            console.log('Result:', {
                isCorrect,
                spokenText: speechResult,
                correctAnswer: target,
                timestamp: new Date().toISOString()
            });
            
            if (isCorrect) {
                title.textContent = 'Correct!';
                message.textContent = 'Great job!';
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745; font-size: 4rem;"></i>';
                if (nextButton) nextButton.classList.remove('d-none');
                
                const speechBtn = document.getElementById('start-speech-btn');
                if (speechBtn) {
                    speechBtn.classList.add('btn-success');
                    speechBtn.innerHTML = '<i class="fas fa-check"></i> Correct';
                }
                
                // Auto-advance to next question after a short delay
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn) {
                    setTimeout(() => {
                        nextBtn.click();
                    }, 1500);
                }
            } else {
                title.textContent = 'Try Again';
                message.textContent = 'That\'s not quite right.';
                icon.innerHTML = '<i class="fas fa-times-circle" style="color: #dc3545; font-size: 4rem;"></i>';
                if (nextButton) nextButton.classList.add('d-none');
                
                const speechBtn = document.getElementById('start-speech-btn');
                if (speechBtn) {
                    speechBtn.classList.add('btn-danger');
                    speechBtn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
                }
            }
            
            // Display what the student actually said
            const spokenTextDisplay = speechResult || '(No speech detected)';
            if (userAnswerEl) {
                userAnswerEl.innerHTML = `<span class="recognized-text">${spokenTextDisplay}</span>`;
            }
            
            // Show the correct answer
            if (correctAnswerEl) {
                correctAnswerEl.innerHTML = `Expected: <span class="expected-answer">${target}</span>`;
            }
            
            if (pointsEl) {
                pointsEl.textContent = isCorrect ? '1' : '0';
            }
            
            // Function to show section complete modal
            function showSectionCompleteModal() {
                console.group('showSectionCompleteModal');
                console.log('Current state:', {
                    currentSectionIndex,
                    currentItemIndex,
                    sectionCount: currentTest.sections.length,
                    currentSection: currentTest.sections[currentSectionIndex] ? {
                        title: currentTest.sections[currentSectionIndex].title,
                        itemCount: currentTest.sections[currentSectionIndex].items.length
                    } : 'undefined'
                });
                
                const modal = document.getElementById('section-complete-modal');
                const section = currentTest.sections[currentSectionIndex];
                
                if (!modal) {
                    console.error('Section complete modal not found in DOM');
                    console.groupEnd();
                    return;
                }
                
                if (!section) {
                    console.error('Current section not found!', {currentSectionIndex, sections: currentTest.sections});
                    console.groupEnd();
                    return;
                }
                
                // Update the message with the section name if available
                const message = document.getElementById('section-complete-message');
                const details = document.getElementById('section-complete-details');
                
                if (message) {
                    message.textContent = `You've completed ${section.title || 'the section'}!`;
                }
                
                if (details) {
                    const correctCount = section.items.filter(item => 
                        item.attempts && item.attempts.some(a => a.isCorrect)
                    ).length;
                    details.textContent = `You answered ${correctCount} out of ${section.items.length} questions correctly.`;
                }
                
                // Show the modal
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
                
                // Set up continue button
                const continueBtn = document.getElementById('continue-to-next-section');
                if (continueBtn) {
                    console.log('Setting up continue button');
                    
                    // Remove any existing event listeners
                    const newContinueBtn = continueBtn.cloneNode(true);
                    continueBtn.parentNode.replaceChild(newContinueBtn, continueBtn);
                    
                    newContinueBtn.onclick = () => {
                        console.group('Continue Button Clicked');
                        console.log('Current state before navigation:', {
                            currentSectionIndex,
                            currentItemIndex,
                            sectionCount: currentTest.sections.length,
                            nextSectionExists: currentSectionIndex < currentTest.sections.length - 1
                        });
                        
                        modal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        
                        // Move to next section if available
                        if (currentSectionIndex < currentTest.sections.length - 1) {
                            const nextSectionIndex = currentSectionIndex + 1;
                            console.log(`Moving to next section: ${nextSectionIndex}`, {
                                nextSection: currentTest.sections[nextSectionIndex] ? {
                                    title: currentTest.sections[nextSectionIndex].title,
                                    itemCount: currentTest.sections[nextSectionIndex].items.length
                                } : 'undefined'
                            });
                            
                            currentSectionIndex = nextSectionIndex;
                            currentItemIndex = 0;
                            attempts = 0;
                            
                            console.log('State after navigation:', {
                                currentSectionIndex,
                                currentItemIndex,
                                section: currentTest.sections[currentSectionIndex]?.title
                            });
                            
                            console.groupEnd(); // Close click group
                            renderCurrentItem();
                        } else {
                            console.log('No more sections - submitting test');
                            console.groupEnd(); // Close click group
                            submitTest();
                        }
                    };
                    
                    console.log('Continue button setup complete');
                }
                
                // Close button handler
                const closeBtn = modal.querySelector('.close-modal');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        console.log('Section complete modal closed');
                        modal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    };
                }
                
                // Add keyboard event listener for Escape key
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        modal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
                
                // Clean up event listeners when modal is closed
                const cleanup = () => {
                    document.removeEventListener('keydown', handleKeyDown);
                    modal.removeEventListener('transitionend', cleanup);
                };
                
                modal.addEventListener('transitionend', cleanup);
            }
            
            // Function to close the modal
            function closeModal() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                document.body.classList.remove('modal-open');
            }
            
            // Show the modal with animation
            const resultModal = document.getElementById('result-modal');
            if (resultModal) {
                resultModal.style.display = 'flex';
                setTimeout(() => {
                    const modalContent = resultModal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.transform = 'translateY(0)';
                        modalContent.style.opacity = '1';
                    }
                    
                    // Auto-close modal after 1.5 seconds if answer is correct
                    if (isCorrect) {
                        setTimeout(() => {
                            resultModal.style.display = 'none';
                            // Move to next question
                            if (currentItemIndex < currentTest.sections[currentSectionIndex].items.length - 1) {
                                currentItemIndex++;
                                renderCurrentItem();
                                // Re-enable speech button for next question
                                const speechBtn = document.getElementById('start-speech-btn');
                                if (speechBtn) {
                                    speechBtn.disabled = false;
                                    speechBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Speaking';
                                    speechBtn.classList.remove('btn-success', 'btn-danger');
                                    speechBtn.classList.add('btn-primary');
                                }
                            } else if (currentSectionIndex < currentTest.sections.length - 1) {
                                // Move to next section if available
                                currentSectionIndex++;
                                currentItemIndex = 0;
                                renderCurrentItem();
                            } else {
                                // End of test
                                const nextBtn = document.getElementById('next-item-btn');
                                if (nextBtn) nextBtn.disabled = false;
                            }
                        }, 1500);
                    }
                }, 10);
            }
                
            // Update the button to show try again state
            const speechBtn = document.getElementById('start-speech-btn');
            if (speechBtn) {
                speechBtn.innerHTML = isCorrect ? '<i class="fas fa-check"></i> Correct!' : '<i class="fas fa-redo"></i> Try Again';
                speechBtn.classList.remove('btn-primary');
                speechBtn.classList.add(isCorrect ? 'btn-success' : 'btn-danger');
                speechBtn.disabled = isCorrect; // Disable button if answer is correct
            }
            
            const startButton = document.getElementById('startTestBtn');
            if (startButton) {
                startButton.innerHTML = isCorrect ? '<i class="fas fa-check"></i> Correct!' : '<i class="fas fa-microphone"></i> Try Again';
                startButton.classList.remove('btn-success', 'btn-primary');
                startButton.classList.add(isCorrect ? 'btn-success' : 'btn-primary');
                startButton.classList.remove('listening');
                startButton.disabled = isCorrect; // Disable button if answer is correct
            }
            
            // Enable next button if answer is correct
            const nextBtn = document.getElementById('next-item-btn');
            if (nextBtn && isCorrect) {
                nextBtn.disabled = false;
                nextBtn.focus(); // Move focus to next button
            }
            
            // Save this attempt
            if (!item.attempts) item.attempts = [];
            item.attempts.push({
                attempt: attempts,
                isCorrect: isCorrect,
                transcript: spokenText,
                timestamp: new Date().toISOString()
            });
            
            isListening = false;
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error', event.error);
            
            // Update UI to show error state
            const resultContainer = document.getElementById('result-container');
            const startButton = document.getElementById('start-speech-btn');
            
            if (resultContainer) {
                resultContainer.className = 'result-container show incorrect';
                const resultIcon = resultContainer.querySelector('.result-icon');
                const resultText = resultContainer.querySelector('.result-text');
                const resultMessage = resultContainer.querySelector('.result-message');
                
                if (resultIcon) resultIcon.innerHTML = '';
                if (resultText) resultText.textContent = 'Error';
                if (resultMessage) resultMessage.textContent = 'There was an error with speech recognition. Please try again.';
            }
            
            if (startButton) {
                startButton.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                startButton.classList.remove('listening');
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-danger');
            }
            
            isListening = false;
        };
        
        recognition.onend = function() {
            console.log('Speech recognition ended');
            const startButton = document.getElementById('start-speech-btn');
            
            if (isListening) {
                // Only reset if we didn't get a result
                if (startButton) {
                    startButton.classList.remove('listening');
                    startButton.innerHTML = '<i class="fas fa-microphone"></i> Try Again';
                    startButton.classList.remove('btn-primary');
                    startButton.classList.add('btn-danger');
                }
                
                // Show no speech detected message
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.className = 'result-container show incorrect';
                    const resultIcon = resultContainer.querySelector('.result-icon');
                    const resultText = resultContainer.querySelector('.result-text');
                    const resultMessage = resultContainer.querySelector('.result-message');
                    
                    if (resultIcon) resultIcon.innerHTML = '';
                    if (resultText) resultText.textContent = 'No speech detected';
                    if (resultMessage) resultMessage.textContent = 'Please try speaking again.';
                }
            }
            
            isListening = false;
        };
        
        // Initialize any remaining components
        if (typeof window !== 'undefined') {
            window.addEventListener('load', function() {
                try {
                    // Additional initialization code can go here
                    console.log('Page fully loaded and initialized');
                } catch (error) {
                    console.error('Error during page load initialization:', error);
                }
            });
        }
        
        // Close any open blocks or functions that might be causing the 'Unexpected end of input' error
        if (typeof initializeModal === 'undefined') {
            window.initializeModal = function() {
                // Implementation if needed
                console.log('Modal initialization function called');
            };
        }
        
        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            if (typeof initializeModal === 'function') {
                try {
                    initializeModal();
                } catch (error) {
                    console.error('Error initializing modal:', error);
                }
            }
        });
        
        // Close any open blocks or functions
        if (typeof window !== 'undefined') {
            // Additional initialization code can go here
            console.log('Page fully loaded and initialized');
        }
        
        // Close any remaining open blocks
        if (typeof window !== 'undefined') {
            // Ensure all event listeners and functions are properly closed
            console.log('All initialization complete');
        }
        
        // Close any remaining open blocks or functions
        if (typeof window !== 'undefined') {
            // Final cleanup and initialization
            console.log('Final initialization complete');
            
            // Ensure all required functions are defined
            if (typeof window.initializeModal === 'undefined') {
                window.initializeModal = function() {
                    console.log('Default modal initialization');
                };
            }
        }
        
        // Final closure to ensure all blocks are properly closed
        (function() {
            console.log('All scripts loaded and initialized');
        })();
    </script>
    

    
    <!-- Test Summary Modal -->
    <div id="test-summary-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-check text-primary"></i> Test Summary</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="summary-stats">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="total-questions">0</h4>
                            <p class="text-muted mb-0">Total Questions</p>
                        </div>
                        <div class="col-4">
                            <h4 id="correct-answers">0</h4>
                            <p class="text-muted mb-0">Correct Answers</p>
                        </div>
                        <div class="col-4">
                            <h4 id="score-percentage">0%</h4>
                            <p class="text-muted mb-0">Score</p>
                        </div>
                    </div>
                </div>
                
                <div class="section-results mt-4">
                    <h5 class="mb-3">Section Results</h5>
                    <div id="section-results-container">
                        <!-- Section results will be added here dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="back-to-test-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Test
                </button>
                <button id="confirm-submit-btn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit Test
                </button>
            </div>
        </div>
    </div>
</body>
</html>
